<!-- Navigation info -->
<ul id="nav-info" class="clearfix">
	<li><a href="index.html"><i class="fa fa-home"></i></a></li>
	<li><a href="javascript:void(0)">데이터관리</a></li>
	<li class="active"><a href="javascript:void(0)">센서대시보드</a></li>
</ul>
<!-- END Navigation info -->

<h3 class="page-header page-header-top">
	센서대시보드 <small id='dashname'> </small>
</h3>

<style>
.push table th {
	text-align: center;
	padding: 0px 10px 0px 10px;
	border: 1px solid white
}

.push table td, th {
	padding: 0px 2px 0px 2px;
	border: 1px solid white
}

.dashlist th {
	text-align: center;
	padding: 0px 10px 0px 10px;
	border: 1px solid lightgray
}

.dashlist td {
	padding: 0px 10px 0px 10px;
	border: 1px solid lightgray
}

.text,.sensortext {
	text-align: center;
	display:table-cell;
	vertical-align:middle;
}

</style>

<div class="push_dash">
	<table>
		<tr>
			<th class='W'>설비</th>
			<td class='W' style='border:1px solid white;'><select id='facilityid'><option>설비선택</option></select></td>
			<th class='W'>센서</th>
			<td class='W' style='border:1px solid white;'><input id='sensors' class="col-md-10" readonly><input
				type='hidden' id='sensorids'>
			<button type="button" id="btnsensor">
					<i class="fa fa-list"></i>
				</button>
			</td>
			<td class='W' style='border:1px solid white;'><select class='W' id='range'><option
						value="">직접선택</option>
					<option value='60s'>최근1분</option>
					<option value='180s'>최근3분</option>
					<option value='300s'>최근5분</option>
					<option value='600s' selected>최근10분</option></select>
			</td>
			<td class='W range hide' style='border:1px solid white;'><input type="text" name="fdate"
				class="input-datepicker"><select name="fhour" class='hour'></select><select
				name="fminute" class='minute'></select>~ <input type="text"
				name="tdate" class="input-datepicker"><select name="thour"
				class='hour'></select><select name="tminute" class='minute'></select>
			</td>
			<td class='W'></td>
			<td style='border:1px solid white;'>
				<button type="button" class=" W btn btn-success"
					id='btnAdd' title="라인차트 추가">
					<i class="fa fa-bar-chart-o"></i> 라인차트 추가
				</button>
				<button type="button" class="W btn btn-success" id='btnAddpie'
					title="파이차트 추가">
					<i class="fa fa-circle-o-notch"></i> 파이차트 추가
				</button>

				<button type="button" class="W btn btn-success" id='btnAddtext'
					title="Text 추가">Text추가</button>
				<button type="button" class="W btn btn-success"
					id='btnAddsensortext' title="Sensor값 추가">센서값추가</button>
				<button type="button" class="W btn btn-success" id='btnAddBack'
					title="배경이미지">배경이미지</button>

				<br>
				<button type="button" class="btn btn-success" id='btnMax'
					title="전체화면">
					<i class="fa fa-desktop"></i> 전체화면
				</button>
				<button type="button" class="btn btn-default" id='dashboardNew'
					title="신규">
					<i class="fa fa-file-o"></i> 신규
				</button>
				<button type="button" class="W btn btn-default" id='dashboardSave'
					title="저장">
					<i class="fa fa-floppy-o"></i> 저장
				</button>
				<button type="button" class="btn btn-default" id='dashboardOpen'
					title="목록관리">
					<i class="fa fa-list-ul"></i> 목록관리
				</button>
				<button type="button" class="W btn btn-default" id='btnlayout'
					title="레이이아웃편집">
					<i class="fa fa-pencil-square-o"></i> 레이아웃편집
				</button> <select class='W' id="timer"><option value="">갱신안함</option>
					<option value="3">3초주기갱신</option>
					<option value="5">5초주기갱신</option>
					<option value="10">10초주기갱신</option></select>
			</td>
		</tr>
	</table>

</div>

<!-- modal form -->
<div id="group-modal" class="modal">
	<!-- Modal Dialog -->
	<div class="modal-dialog">
		<!-- Modal Content -->
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">×</button>
				<h4>센서 선택</h4>
			</div>
			<!-- END Modal Header -->

			<!-- Modal Content -->
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<label class="control-label col-md-3">센서 </label>
						<div class="col-md-9">
							<input type="text" name="sensors" class="form-control" value=""
								readonly> <input type="hidden" name="sensorids"
								class="form-control" value="" readonly>
							<div class='sensors'
								style='border: 1px solid lightgray; overflow: auto; height: 400px;'>
								<input type=checkbox id=s1><label for=s1>센서1</label><br>
								<input type=checkbox id=s2><label for=s2>센서2</label><br>
								<input type=checkbox id=s3><label for=s3>센서3</label><br>
								<input type=checkbox id=s4><label for=s4>센서4</label><br>
							</div>
						</div>
					</div>
				</form>
			</div>
			<!-- END Modal Content -->

			<!-- Modal footer -->
			<div class="modal-footer remove-margin">
				<button type="button" class="btn btn-danger" data-dismiss="modal">
					<i class="fa fa-times"></i> 닫기
				</button>
				<button type="button" class="btn btn-success" id="btnSave">
					<i class="fa fa-check"></i> 확인
				</button>
			</div>
			<!-- END Modal footer -->
		</div>
		<!-- END Modal Content -->
	</div>
	<!-- END Modal Dialog -->
</div>

<div id="save-modal" class="modal">
	<!-- Modal Dialog -->
	<div class="modal-dialog">
		<!-- Modal Content -->
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">×</button>
				<h4>대시보드저장</h4>
			</div>
			<!-- END Modal Header -->

			<!-- Modal Content -->
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<label class="control-label col-md-3">이름</label>
						<div class="col-md-9">
							<input type="text" name="name" class="form-control" value="">
							<input type="hidden" name="id" class="form-control" value="">
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-3">미리보기</label>
						<div class="col-md-9">
							<img name='preview' width='100%'>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-3">조회권한</label>
						<div class="col-md-9">
							<div class='rpermission permissionlst'
								style='border: 1px solid lightgray; overflow: auto; height: 100px;'>
							</div>
							<div>
								<input type="text" name="ptxtfind" class="col-md-3" value=""
									placeholder='그룹또는사용자'>
								<button name='pbtnfind' type="button">검색</button>
								<select name='pcbfind' type="button"><option value=''>그룹또는사용자</option></select>
								<button name='pbtnadd' type="button">추가</button>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-3">수정권한</label>
						<div class="col-md-9">
							<div class='wpermission permissionlst'
								style='border: 1px solid lightgray; overflow: auto; height: 100px;'>
							</div>
							<div>
								<input type="text" name="ptxtfind" class="col-md-3" value=""
									placeholder='그룹또는사용자'>
								<button name='pbtnfind' type="button">검색</button>
								<select name='pcbfind' type="button"><option value=''>그룹또는사용자</option></select>
								<button name='pbtnadd' type="button">추가</button>
							</div>
						</div>
					</div>
					<form>
			</div>
			<!-- END Modal Content -->

			<!-- Modal footer -->
			<div class="modal-footer remove-margin">
				<button type="button" class="btn btn-danger" data-dismiss="modal">
					<i class="fa fa-times"></i> 닫기
				</button>
				<button type="button" class="btn btn-success">
					<i class="fa fa-check"></i> 확인
				</button>
			</div>
			<!-- END Modal footer -->
		</div>
		<!-- END Modal Content -->
	</div>
	<!-- END Modal Dialog -->
</div>

<div id="open-modal" class="modal">
	<!-- Modal Dialog -->
	<div class="modal-dialog">
		<!-- Modal Content -->
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">×</button>
				<h4>대시보드관리</h4>
			</div>
			<!-- END Modal Header -->

			<!-- Modal Content -->
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<label class="control-label col-md-3">대시보드목록</label>
						<div id='dashboards' class="col-md-9"
							style='max-height: 600px; overflow: auto'></div>
					</div>
				</form>
			</div>
			<!-- END Modal Content -->

			<!-- Modal footer -->
			<div class="modal-footer remove-margin">
				<button type="button" class="btn btn-danger" data-dismiss="modal">
					<i class="fa fa-times"></i> 닫기
				</button>
				<!-- <button type="button" class="btn btn-success" ><i class="fa fa-check"></i> 확인</button> -->
			</div>
			<!-- END Modal footer -->
		</div>
		<!-- END Modal Content -->
	</div>
	<!-- END Modal Dialog -->
</div>
<div id="setting-modal" class="modal">
	<!-- Modal Dialog -->
	<div class="modal-dialog">
		<!-- Modal Content -->
		<div class="modal-content">
			<!-- Modal Header -->
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">×</button>
				<h4>설정 선택</h4>
			</div>
			<!-- END Modal Header -->

			<!-- Modal Content -->
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<label class="control-label col-md-3">텍스트: </label>
						<div class="col-md-9">
							<input type="text" name="text" class="form-control" value="">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-3">글자색: </label>
						<div class="col-md-9">
							<input type="text" name="color" class="form-control" value="">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-3">배경색: </label>
						<div class="col-md-9">
							<input type="text" name="bgcolor" class="form-control" value="">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-3">폰트크기: </label>
						<div class="col-md-9">
							<select name='fontsize' class="form-control">
								<option value='10'>10</option>
								<option value='15'>15</option>
								<option value='10'>20</option>
								<option value='25'>25</option>
								<option value='30'>30</option>
								<option value='35'>35</option>
								<option value='40'>40</option>
								<option value='45'>45</option>
								<option value='50'>50</option>
								<option value='55'>55</option>
								<option value='60'>60</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-3">폰트굵기: </label>
						<div class="col-md-9">
							<select name='fontweight' class="form-control">
								<option value='normal'>normal</option>
								<option value='bold'>bold</option>
								<option value='100'>100</option>
								<option value='200'>200</option>
								<option value='300'>300</option>
								<option value='400'>400</option>
								<option value='500'>500</option>
								<option value='600'>600</option>
								<option value='700'>700</option>
								<option value='800'>800</option>
								<option value='900'>900</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-3">폰트종류: </label>
						<div class="col-md-9">
							<select name='fontname' class="form-control">
								<option value=''>default</option>
								<option value='굴림'>굴림</option>
								<option value='굴림체'>굴림체</option>
								<option value='바탕'>바탕</option>
								<option value='바탕체'>바탕체</option>
								<option value='돋움'>돋움</option>
								<option value='돋움체'>돋움체</option>
								<option value='궁서'>궁서</option>
								<option value='궁서체'>궁서체</option>
								<option value='Arial'>Arial</option>
								<option value='Arial Black'>Arial Black</option>
								<option value='Comic Sans MS'>Comic Sans MS</option>
								<option value='Courier'>Courier</option>
								<option value='Impact'>Impact</option>
								<option value='MS Gothic'>MS Gothic</option>
							</select>
						</div>
					</div>
				</form>
			</div>
			<!-- END Modal Content -->

			<!-- Modal footer -->
			<div class="modal-footer remove-margin">
				<button type="button" class="btn btn-danger" data-dismiss="modal">
					<i class="fa fa-times"></i> 닫기
				</button>
				<button type="button" class="btn btn-success" id="btnSave">
					<i class="fa fa-check"></i> 확인
				</button>
			</div>
			<!-- END Modal footer -->
		</div>
		<!-- END Modal Content -->
	</div>
	<!-- END Modal Dialog -->
</div>

<!-- END user modal form -->

<div id=charts style='position: relative;'></div>

<input type="file" accept="image/*" id='file' style="display: none">

<!-- 스크립트 영역 -->
<script type="text/javascript">

$('[name=pbtnfind]').click(function() {
	var cbobj = $(this).parent().children('[name=pcbfind]');	
	$.post(App.baseurl+"/list",{qid:"permissionfind",name:$(this).parent().children('[name=ptxtfind]').val()}).done(
        	function(res){
        		if(res.success)
        		{
        			cbobj.empty().append('<option value="">'+res.list.length+' 개 검색됨</option>');
        			
        			for(var i=0; i<res.list.length; i++)
        			{
        				var item = res.list[i];
        				cbobj.append('<option value="'+item.id+'">'+item.name+'('+item.type+')</option>');
        			}
        		}
        	});
	
});

$('[name=pbtnadd]').click(function() {
	var divobj = $(this).parent().parent().children('.permissionlst');
	var cbobj = $(this).parent().children('[name=pcbfind]');
	var val = cbobj.val();
	if(val=="") return;
	var txt = cbobj.children('option:selected').text();
	divobj.append('<div>&nbsp;<button name=pbtndel type="button">삭제</button>&nbsp;<input type=hidden name=permission value="'+val+'">'+txt+'<br></div>');
});

$(document).off('click','[name=pbtndel]').on('click','[name=pbtndel]',function() {
	$(this).parent().remove();
});

colors = [
	'255, 99, 132',
	'54, 162, 235',
	'255, 206, 86',
	'75, 192, 192',
	'153, 102, 255',
	'255, 159, 64'];

for(var i=0; i<100; i++) colors.push(""+Math.floor(Math.random()*255)+","+Math.floor(Math.random()*255)+","+Math.floor(Math.random()*255));

function graph(selector, type, data, labels) {

	var ds = [];
	
//	var colors = [];


	if(!Array.isArray(data[1][0]))
	{
		ds.push({
			legend: true,
			tooltips: true,
			label: labels[1],
			data: data[1],
			backgroundColor:'rgba(255, 99, 132, 0.2)',
			borderColor: 'rgba(255,99,132,1)',
			borderWidth: 1,  //선굵기
			pointRadius: 2,
			pointHoverRadius: 2,
			fill:true

		 });
	}
	else
	{
		for(var i=0; i<data[1].length; i++)
		{
			ds.push({
				legend: true,
				tooltips: true,
				label: labels[1][i],
				data: data[1][i],
				backgroundColor:"rgba("+colors[i]+",0.2)",
				borderColor: "rgba("+colors[i]+",1)",
				borderWidth: 1, //선굵기
				pointRadius: 2,
				pointHoverRadius: 2,
				fill:true
			 });
		}
	
	}
	var chart = new Chart(selector, {
		type: type, //그래프 형태 지정하기
			data: {
				labels: data[0], //X축 제목
				datasets: ds,
			},
			options: {
//				responsive: true,
				maintainAspectRatio: false,
				scales: { //X,Y축 옵션
				yAxes: [{
					ticks: {
							beginAtZero: true //Y축의 값이 0부터 시작
						}
					}],
				},
				legend: {
					display: true
				},
				animation: {
					duration: 0
				}
			}
	});	
//	console.log('chart end', new Date());
	return chart;
}

var dev_hash = {};

// 센서id목록을 이름목록으로...
function sensor_names(sensors)
{
	var names = [];
	var sids = [];
	
	if(sensors===undefined || sensors==null || sensors=="") {
		$('[name=sensorids]').val("");
		return "";
	}
	
	var ids = sensors.split(",");
	for(var i=0; i<ids.length; i++)
		if(ids[i].length>0) { 
			names.push(dev_hash[ids[i]].name);
			sids.push(ids[i]);
			
			$('[value='+ids[i]+']').prop('checked', true);
		}
	
	$('[name=sensorids]').val(sids.join(","));
	
	return names.length>0?names.join(","):"";
}

// sensors 정보
function sensor_infos(sensors)
{
	var infos = [];
	
	if(sensors===undefined || sensors==null || sensors=="") return [];
	
	var ids = sensors.split(",");
	for(var i=0; i<ids.length; i++)
		if(ids[i].length>0) { 
			infos.push(dev_hash[ids[i]]);
		}
	
	return infos;
}

function sensor_cols(sensors)
{
	var names = [];
	
	if(sensors===undefined || sensors==null || sensors=="") return "";
	
	var ids = sensors.split(",");
	for(var i=0; i<ids.length; i++)
		if(ids[i].length>0) { 
			names.push('"'+dev_hash[ids[i]].vname+'" as "'+dev_hash[ids[i]].name+'"');
		}
	
	return names.length>0?names.join(","):"";
}

$(document).off('click','[name=sensor]').on('click','[name=sensor]',function() {
	var sensors = $('[name=sensorids]').val();
	var txt = $(this).next().text();
	
	if($(this).is(":checked")) // +
	{
		sensors += (sensors.length>0?",":"")+ $(this).val();
	}
	else // -
	{
		sensors = sensors.split($(this).val()).join('');
	}
//	$('[name=sensor]').prop('checked', false);
	$('[name=sensors]').val(sensor_names(sensors));
});

// 센서id목록을 이름목록으로...
function loadsensor(facilityid, callback)
{
    $.post(App.baseurl+"/list",{qid:"facilitysensorlist",facilityid:facilityid}).done(
        	function(res){
        		$('.sensors').empty();
        		if(res.success)
        		{
        			for(var i=0; i<res.list.length; i++)
        			{
        				var item = res.list[i]; 
            			$('.sensors').append('&nbsp;<input name="sensor" type="checkbox" id="s'+i+'" value="'+item.deviceid+'"><label for="s'+i+'" style="width:100px">&nbsp;'+item.devicename+'</label><br>');
        			}
        			callback();
        		}
        	});
}

$('#btnsensor,#sensors').click(function() {
	loadsensor($('#facilityid').val(), function() {
		$('[name=sensors]').val(sensor_names($('#sensorids').val()));
		$('[name=sensorids]').val($('#sensorids').val());
		
		$('#group-modal').modal({backdrop:'static'});
	});
});


$('#btnSave').click(function() {
	$('#sensors').val($('[name=sensors]').val());
	$('#sensorids').val($('[name=sensorids]').val());
	$('#group-modal').modal('hide');
});

$('#range').change(function(){
	if($('#range').val()=="") $('.range').removeClass('hide');
	else $('.range').addClass('hide');
});

$('#facilityid').change(function(){
	$('#sensors').val('');
	$('#sensorids').val('');
});


function makechartobj(id)
{
	var chartobj = {};
	if(App.chid===undefined) App.chid = 0;
 	if(App.chartobjs===undefined) App.chartobjs = [];
 	
	if(id===undefined)
	{
		App.chid++;
		chartobj.id = "chart"+App.chid;
	}
	else 
	{
		chartobj.id = id;
		var cid = Number(id.replace("chart", ""));
		if(cid>App.chid) App.chid = cid;
	}
 	
	return chartobj;
}

// chart 추가, id 가 있으면 .. load 
function addchart(facilityid, sensorids, range, ftime, ttime, timer, id, left, top, width, height)
{
//	if(App.chid==undefined) App.chid = 0;
// 	if(App.chartobjs==undefined) App.chartobjs = [];

	var chartobj = makechartobj(id);
	
	var cols = sensor_cols(sensorids);
	var sql = "select "+cols+ " from "+facilityid+" "; 
	if(range=="") {
		sql += "where time >='"+ftime+"' and time <='"+ttime+"'";
	}
	else
		sql += "where time >=now()-"+range;
	sql += " order by time";

//	App.chid++;
//	if(id===undefined)
//		chartobj.id = "chart"+App.chid;
//	else 
//		chartobj.id = id;
	
	var style = "display:inline-block;width:95%;height:400px;";
	if(left!==undefined) style = "position:absolute;left:"+left+"px;top:"+top+"px;width:"+width+"px;height:"+height+"px;";
	$("#charts").append("<div class='chart' style='"+style+"'><canvas id="+chartobj.id+" width=400 height=400></canvas></div>");
	
	if(id===undefined) App.start_loading('검색중...');

    chartobj.facilityid = facilityid;
    chartobj.cols = cols;
    chartobj.ids = sensorids;
    chartobj.range = range;
    chartobj.ftime = ftime;
    chartobj.ttime = ttime;
    chartobj.timer_interval = timer;
    chartobj.type = "line";
    chartobj.sql = sql;
    chartobj.left = left;
    chartobj.top = top;
    chartobj.width = width;
    chartobj.height = height;
	
	query("facility", sql, function(issuccess, result) {
		if(id===undefined) App.stop_loading();
		if(issuccess)
		{
			var xvals = [];
			var yvals = [];
			var ylabel = [];

			// columns info
			for(var i=0;i<result.results[0].series[0].columns.length; i++)
			{
				var item = result.results[0].series[0].columns[i];
				if(i>0) ylabel.push(item);
			}
			
//			console.log("labels", ylabel);
			// values
			for(var i in result.results[0].series[0].values)
			{
				var items = result.results[0].series[0].values[i];
				var t = (new Date(items[0])).format("HH:mm:ss");
				xvals.push(t);
				
				for(var c=1; c<items.length;c++) {
					if(i==0) 
						yvals.push([ items[c] ]);
					else
						yvals[c-1].push(items[c]);
				}
			}
			chartobj.data = {vals:[xvals,yvals],labels:["시간",ylabel]};
			chartobj.obj = graph(chartobj.id, "line", chartobj.data.vals,chartobj.data.labels);
		}
	});
	chartobj.timer = null; //setTimeout();
	if(chartobj.timer_interval!="") chartobj.timer = setTimeout(refreshchart, 1000*chartobj.timer_interval, chartobj);
	
	App.chartobjs.push(chartobj);
}

// refreshchart
function refreshchart(chartobj)
{
//	console.log('refreshchart_'+chartobj.id+(new Date()).format('yyyy-MM-dd HH:mm:ss'));
	if($('#'+chartobj.id).length<=0) {
		return;
	}
	
	query("facility", chartobj.sql, function(issuccess, result, param) {
		if(issuccess)
		{
			var xvals = [];
			var yvals = [];
			var ylabel = [];

			// columns info
			for(var i=0;i<result.results[0].series[0].columns.length; i++)
			{
				var item = result.results[0].series[0].columns[i];
				if(i>0) ylabel.push(item);
			}
			
//			console.log("labels", ylabel);
			// values
			for(var i in result.results[0].series[0].values)
			{
				var items = result.results[0].series[0].values[i];
				var t = (new Date(items[0])).format("HH:mm:ss");
				xvals.push(t);
				
				for(var c=1; c<items.length;c++) {
					if(i==0) 
						yvals.push([ items[c] ]);
					else
						yvals[c-1].push(items[c]);
				}
			}
			chartobj.data = {vals:[xvals,yvals],labels:["시간",ylabel]};
			if(chartobj.obj!=null) {
				chartobj.obj.destroy();
				chartobj.obj = null;
			}
			chartobj.obj = graph(chartobj.id, "line", chartobj.data.vals,chartobj.data.labels);
		}
		else
		{
			console.log('query error...['+chartobj.sql+']', chartobj);
		}
		if(chartobj.timer!=null) {
			clearTimeout(chartobj.timer);
			chartobj.timer = null;
		}
		if(chartobj.timer_interval!="") chartobj.timer = setTimeout(refreshchart, 1000*chartobj.timer_interval, chartobj);
	});
}

//chart,pie allclear()
function clearAllChart()
{
	if(App.chartobjs==undefined) return;
	for(var i=0; i<App.chartobjs.length; i++)
	{
		var chartobj = App.chartobjs[i];
		if(chartobj.timer!==undefined && chartobj.timer!=null) clearTimeout(chartobj.timer);
		if(chartobj.obj!==undefined && chartobj.obj!=null) chartobj.obj.destroy();
		if(chartobj.type=="line" || chartobj.type=="pie") $('#'+chartobj.id).parent().remove();
		else $('#'+chartobj.id).remove();
	}
	App.chartobjs =[];
	App.chid = 0;
	
	$('#save-modal [name=name]').val('');
	$('#save-modal [name=id]').val('');
//	$('#save-modal [name=permission]').val('');
	$('#dashname').text('');
	$('.W').show();
	$('#btnlayout').html('<i class="fa fa-pencil-square-o"></i> 레이아웃편집');
}

//chart,pie deleteclear()
function deleteChart(id)
{
	if(App.chartobjs==undefined) return;
	for(var i=0; i<App.chartobjs.length; i++)
	{
		var chartobj = App.chartobjs[i];
		if(chartobj.id==id){
			console.log('delete', chartobj);
			if(chartobj.timer!==undefined && chartobj.timer!=null) {
				clearTimeout(chartobj.timer);
				chartobj.timer = null;
			}
			if(chartobj.obj!==undefined && chartobj.obj!=null) chartobj.obj.destroy();
			
			if(chartobj.type=="line" || chartobj.type=="pie") $('#'+chartobj.id).parent().remove();
			else if(chartobj.type=="text" || chartobj.type=="sensortext" || chartobj.type=="img")  $('#'+chartobj.id).remove();
			App.chartobjs.splice(i, 1);
			break;
		}
	}
}

//pie 추가 id 가 있으면 load
function addpie(facilityid, sensorids, range, ftime, ttime, timer, id, left, top, width, height)
{
//	if(App.chid==undefined) App.chid = 0;
// 	if(App.chartobjs==undefined) App.chartobjs = [];
 	
 	var sids = sensorids.split(",");
	var infos = sensor_infos(sensorids);
	
//	console.log('infos',infos);
 	
 	for(var ci=0; ci<sids.length; ci++)
 	{
 		var chartobj = makechartobj(id); //{};
		
		var cols = sensor_cols(sids[ci]);
		var sql = "select "+cols+ " from "+facilityid+" "; 
		if(range=="") {
			sql += "where time >='"+ftime+"' and time <='"+ttime+"'";
		}
		else
			sql += "where time >=now()-"+range;
		sql += " order by time desc limit 1";
		
//		App.chid++;
//		if(id===undefined) chartobj.id = "pie"+App.chid;
//		else chartobj.id = id;
		chartobj.sql = sql;
		
	    chartobj.facilityid = facilityid;
	    chartobj.cols = cols;
	    chartobj.ids = sids[ci];
	    chartobj.range = range;
	    chartobj.ftime = ftime;
	    chartobj.ttime = ttime;
	    chartobj.timer_interval = timer;
	    chartobj.type = "pie";
	    chartobj.cinfo = infos[ci];
	    chartobj.idx = ci;
	    chartobj.left = left;
	    chartobj.top = top;
	    chartobj.width = width;
	    chartobj.height = height;
		
		query("facility", chartobj.sql, function(issuccess, result, cobj) {
			if(issuccess)
			{
				var xvals = [];
				var yvals = [];
				var ylabel = [];

				// columns info
				for(var i=0;i<result.results[0].series[0].columns.length; i++)
				{
					var item = result.results[0].series[0].columns[i];
					if(i>0) ylabel.push(item);
				}
				
//				console.log("labels", ylabel);
				// values
				for(var i in result.results[0].series[0].values)
				{
					var items = result.results[0].series[0].values[i];
					var t = (new Date(items[0])).format("HH:mm:ss");
					xvals.push(t);
					
					for(var c=1; c<items.length;c++) {
						if(i==0) 
							yvals.push([ items[c] ]);
						else
							yvals[c-1].push(items[c]);
					}
				}
				//chartobj = param;
				
				cobj.data = {vals:[xvals,yvals],labels:["시간",ylabel]};
				
				var style = "display:inline-block; width:400px;height:400px;";
				if(left!==undefined) style = "position:absolute; display:inline-block; left:"+left+"px;top:"+top+"px;width:"+width+"px;height:"+height+"px;";
				
//				console.log("pie",style);
				$("#charts").append("<div class='chart' style='"+style+"'><canvas id="+cobj.id+" width=100% height=100%></canvas></div>");
				
				var maxval = cobj.cinfo.vrange.split("~")[1];

				cobj.obj = pie(cobj.id, cobj.idx, cobj.cinfo.name, maxval, yvals[0][0], null);

				cobj.timer = null; //setTimeout();
				if(cobj.timer_interval!="") cobj.timer = setTimeout(refreshpie, 1000*cobj.timer_interval, cobj);
				
				App.chartobjs.push(cobj);
			}
			else
			{
				console.log('query error...['+chartobj.sql+']');
			}
		},chartobj);
 	}
}

function refreshpie(chartobj)
{
//	console.log('refreshpie_'+chartobj.id+(new Date()).format('yyyy-MM-dd HH:mm:ss'));
	if($('#'+chartobj.id).length<=0) {
		return;
	}
	
	query("facility", chartobj.sql, function(issuccess, result, param) {
		if(issuccess)
		{
			var xvals = [];
			var yvals = [];
			var ylabel = [];

			// columns info
			for(var i=0;i<result.results[0].series[0].columns.length; i++)
			{
				var item = result.results[0].series[0].columns[i];
				if(i>0) ylabel.push(item);
			}
			
//			console.log("labels", ylabel);
			// values
			for(var i in result.results[0].series[0].values)
			{
				var items = result.results[0].series[0].values[i];
				var t = (new Date(items[0])).format("HH:mm:ss");
				xvals.push(t);
				
				for(var c=1; c<items.length;c++) {
					if(i==0) 
						yvals.push([ items[c] ]);
					else
						yvals[c-1].push(items[c]);
				}
			}
			chartobj.data = {vals:[xvals,yvals],labels:["시간",ylabel]};
			
			var maxval = chartobj.cinfo.vrange.split("~")[1];

			chartobj.obj = pie(chartobj.id, chartobj.idx, chartobj.cinfo.name, maxval, yvals[0][0], chartobj.obj);
		}
		else
		{
			console.log('query error...['+chartobj.sql+']', chartobj);
		}
		
		if(chartobj.timer!=null) {
			clearTimeout(chartobj.timer);
			chartobj.timer = null;
		}
		if(chartobj.timer_interval!="") chartobj.timer = setTimeout(refreshpie, 1000*chartobj.timer_interval, chartobj);
	});
}

function pie(id, idx, title, maxval, value, chart)
{
	var keys = [title,''];
	var vals = [value, maxval-value];

	var pieinfo = {
		type : 'doughnut',
		data : {
			datasets : [ {
				data : vals,
				label : title,
				backgroundColor:["rgba("+colors[idx]+",1)", 'lightgrey'],
				borderColor: ["rgba("+colors[idx]+",1)", 'white'],
				borderWidth: 0//[0, 0, 0, 0, 0, 0, 0]
			} ],
			labels : keys
		},
		options : {
			circumference: Math.PI+1,
			rotation: -Math.PI - 0.5,
			legend:{
			display:false,
			position : 'right'
		},
		responsive : true,
		title : {
				display:true,
				text : title+"("+value+")",
				fontSize:20,
				fontStyle:'bold',
				position:'top'
		},
		plugins: {
		          labels: { 
		        	  	render: 'value',
		              	position: 'outside'
		              }	            
		         },
		}
	};

	if(chart==null || chart === undefined)
		chart = new Chart(id,pieinfo);
	else {
		chart.options.title.text = title+"("+value+")";
		chart.data.datasets[0].data = vals;
		chart.data.labels = keys;
		chart.update();
	}

	return chart;
}

$('[name=rpermission],[name=wpermission]').click(function() {

$('#permission-modal').modal({backdrop:'static'});

});

$('#btnAdd,#btnAddpie,#btnAddsensortext').click(function() {
	var facilityid = $('#facilityid option:checked').text();
	var range = $('#range').val();
	var ids = $('#sensorids').val();
	var cols = sensor_cols(ids);
	var ftime = "";
	var ttime = "";
	
	if(facilityid=="") {
		App.msg_alert('오류', '검색 설비를 선택하지 않았습니다.');
		return;
	}
	if(ids=="")	{
		App.msg_alert('오류', '검색 센서를 선택하지 않았습니다.');
		return;
	}
	var sql = "select "+cols+ " from "+facilityid+" "; 
	if(range=="") {
		var fdate = $('[name=fdate]').val();
		var tdate = $('[name=tdate]').val();
		
		if(fdate=="") {
			App.msg_alert('오류', '검색 시작일을 입력하지 않았습니다.');
			return;
		}
		if(tdate=="") {
			App.msg_alert('오류', '검색 종료일을 입력하지 않았습니다.');
			return;
		}
		ftime = fdate + " "+$('[name=fhour]').val()+":"+$('[name=fminute]').val()+":00";
		ttime = tdate + " "+$('[name=thour]').val()+":"+$('[name=tminute]').val()+":00";
		sql += "where time >='"+ftime+"' and time <='"+ttime+"'";
	}
	else
		sql += "where time >=now()-"+range;
	sql += " order by time";
	
    // 저장...
	var save={};
	save.facilityid = $('#facilityid').val();
	save.sensorids = $('#sensorids').val();
	save.sensors = $('#sensors').val();
	save.range = $('#range').val();
	save.fdate = $('[name=fdate]').val();
	save.fhour = $('[name=fhour]').val();
	save.fminute = $('[name=fminute]').val();
	save.tdate = $('[name=tdate]').val();
	save.thour = $('[name=thour]').val();
	save.tminute = $('[name=tminute]').val();
	
	$.post(App.baseurl+"/update",{qid:"configput",key:App.loginid+"_dashboard.html",value:JSON.stringify(save)});
	
	if($(this).text().indexOf("파이")>=0)
	{
		addpie(facilityid, ids, range, ftime, ttime, $('#timer').val());
		return;
	}
	else if($(this).text().indexOf("센서값")>=0)
	{
		addtext(facilityid, ids, range, ftime, ttime, $('#timer').val());
		return;
	}
	
	addchart(facilityid, ids, range, ftime, ttime, $('#timer').val());
	return;

});

(function init(){

	$('.input-datepicker').datepicker({format:"yyyy-mm-dd"});
	for(var i=0; i<24; i++) $('select.hour').append('<option value="'+ i.zf(2) +'">'+ i.zf(2) +'시</option>');
	for(var i=0; i<60; i++) $('select.minute').append('<option value="'+ i.zf(2) +'">'+ i.zf(2) +'분</option>');
	
	// 센서 목록 로딩
    $.post(App.baseurl+"/list",{qid:"devicelist",column:"name"}).done(
        	function(res){
        		$('.sensors').empty();
        		if(res.success)
        		{
        			dev_hash = {};
        			for(var i=0; i<res.list.length; i++)
        			{
        				dev_hash[res.list[i].id] = res.list[i]; 
            			$('.sensors').append('&nbsp;<input name=sensor type=checkbox id=s'+i+' value="'+res.list[i].id+'"><label for=s'+i+'>&nbsp;'+res.list[i].name+'</label><br>');
        			}
        		}
        	});

	// 설비목록 로딩
    $.post(App.baseurl+"/list",{qid:"facilitylist",column:"name"}).done(
        	function(res){
        		$('#facilityid').empty().append('<option value="">설비선택</option>');;
        		if(res.success)
        		{
        			facility_hash = {};
        			for(var i=0; i<res.list.length; i++)
        			{
        				facility_hash[res.list[i].id] = res.list[i]; 
            			$('#facilityid').append('<option value="'+res.list[i].id+'">'+res.list[i].name+'</option>');
        			}
        			
        			$.post(App.baseurl+"/list",{qid:"configget",key:App.loginid+"_dashboard.html"}).done(function(res) {
        				if(res.success && res.list.length>0)
        				{
        					if(res.list[0].value!="")
        					{
        						var save = JSON.parse(res.list[0].value);
        						$('#facilityid').val(save.facilityid);
        						$('#sensorids').val(save.sensorids);
        						$('#sensors').val(save.sensors);
        						$('#range').val(save.range);
        						$('[name=fdate]').val(save.fdate);
        						$('[name=fhour]').val(save.fhour);
        						$('[name=fminute]').val(save.fminute);
        						$('[name=tdate]').val(save.tdate);
        						$('[name=thour]').val(save.thour);
        						$('[name=tminute]').val(save.tminute);
        						$('#range').change();
        					}
        				}
        				
        			});
        			// 기본 대시보드 불러오기
        			$.post(App.baseurl+"/list",{qid:"configget",key:App.loginid+"_defdashboard"}).done(function(res) {
        				if(res.success && res.list.length>0)
        				{
							$('.W').hide();
        					if(res.list[0].value!="")
        					{
        						var v = res.list[0].value.replace("\"data\":\"[","\"data\":[").replace("}]\"}","}]}");
        						
        						var info=JSON.parse(v);
        						
        						console.log(info.name, info.data);
        						
        						updatedashdata(info.name, info.data);
        					}
        				}
        				
        			});
        		}
        	});
	
})();


$.contextMenu({
	selector: '.chart', 
	callback: function(key, options) {
		/*
		if(key=="delete") {
			var id = $(this).attr("id");
			if(_timerid[id+"_refresh"]!==undefined) clearTimeout(_timerid[id+"_refresh"]);
			$(this).remove();
		}
		else 
		*/
		if(key=="setting") {
			var id = $(this).attr("id");
			var obj = $(this);
			var fobj = findchartobj(id);
			if(fobj==null || (fobj.type!="text" && fobj.type!="sensortext")) return;

			$('#setting-modal button.btn-success').off('click').on('click', function() {
				
				obj.css('font-size',$('#setting-modal [name=fontsize]').val()+"px");
				obj.css('font-family',$('#setting-modal [name=fontname]').val());
				obj.css('font-weight',$('#setting-modal [name=fontweight]').val());
				obj.css('color',$('#setting-modal [name=color]').val());
				obj.css('background-color',$('#setting-modal [name=bgcolor]').val());
								
				var fontattr = [$('#setting-modal [name=fontsize]').val(),$('#setting-modal [name=fontname]').val(),$('#setting-modal [name=fontweight]').val(),$('#setting-modal [name=color]').val(),$('#setting-modal [name=bgcolor]').val()].join("|");
				fobj.fontattr = fontattr;
				
				var newtxt = $('#setting-modal [name=text]').val();
				fobj.text = newtxt;
				
				if(fobj.type=="text")
				{
					obj.text(newtxt);
				}
				else
				{
					var val = obj.text();
					var fmt = obj.data("text");
					fmt = fmt.split("{}").join("");
					val = val.split(fmt).join("");
					obj.data("text", newtxt);
					val = newtxt.split("{}").join(val);
					obj.text(val);
				}
				
				$('#setting-modal').modal('hide');
			});
			$('#setting-modal [name=text]').val(fobj.text);
			$('#setting-modal [name=fontsize]').val(obj.css('font-size').replace("px",""));
			$('#setting-modal [name=fontname]').val(obj.css('font-family'));
			$('#setting-modal [name=fontweight]').val(obj.css('font-weight'));
			$('#setting-modal [name=color]').val(obj.css('color'));
			$('#setting-modal [name=bgcolor]').val(obj.css('background-color'));
			
			$('#setting-modal').modal({backdrop:'static'});
			$('#setting-modal .modal-dialog').draggable();
		}
		else if(key=="copy") {
			var pos = $(this).position();
			additem(pos.left+10, pos.top+10, $(this).text());

			//var obj = $("<label class='labelling' style='position:absolute;left:"+($(this).position().left+5)+"px;top:"+($(this).position().top+5)+"px'>"+$(this).text()+"</label>").appendTo('body');
		}
		else if(key=="delete") {
			var id = "";
			if($(this).children('canvas').length>0) id = $(this).children('canvas').attr('id');
			else id = $(this).attr('id');
			deleteChart(id);
		}
	},
	items: {
//		"copy": {name: "복제", icon: "copy"},
		"delete": {name: "삭제", icon: "delete"},
		"setting": {name: "설정", icon: "edit"},
//		"sep1": "---------",
//		"quit": {name: "Quit", icon: function(){
//			return 'context-menu-icon context-menu-icon-quit';
//		}}
	}
});        	


$('#btnMax').click(function() {
	if($('#btnMax').text().trim()=='전체화면'){
		$('#btnMax').html('<i class="fa fa-desktop"></i> 화면복귀');
		$('header').hide();
		$('nav').hide();
		$('#sidebar-search').hide();
		$('#page-content').css('margin','0');
		$('footer').hide();
	} else {
		$('#btnMax').html('<i class="fa fa-desktop"></i> 전체화면');
		$('header').show();
		$('nav').show();
		$('#sidebar-search').show();
		$('#page-content').css('margin','0 0 0 250px');
		$('footer').show();
	}
});

$('#dashboardNew').click(function() {
	App.msg_confirm('대시보드', '대시보드를 새로 만드시겠습니까?', clearAllChart);
});

$('#dashboardSave').click(function() {
	
	if(App.chartobjs === undefined) return; 
	
	//	var objs = App.chartobjs.slice();
	var objs = clonelayout();
	var backimage = $("#charts").css("background-image");
	
	backimage = backimage.split("\"").join("");
	
	if(backimage!="") objs.push({id:"background",type:"background",data:backimage});// 배경...
	
//	console.log("save...", JSON.stringify(objs),objs);
	
	$('#save-modal button.btn-success').off('click').on('click',function() {
		var save = {qid:"dashboardadd"};
		save.data = JSON.stringify(objs);
		save.author = App.loginid;
		save.name = $('#save-modal [name=name]').val();
//		save.permission = $('#save-modal [name=permission]').val();
		save.state = 'ACTIVE';
		save.preview = $('[name=preview]').attr('src');
		
		if($('#save-modal [name=id]').val()!="")
		{
			save.id = $('#save-modal [name=id]').val();
			save.qid = "dashboardupdate";
		}
		
//		console.log('save',save);
		App.start_loading('정보저장중');
		$.post(App.baseurl+"/insert",save).done(function(res) {
			App.stop_loading();
			if(res.success)
			{
				// permission 저장하기...
               	var posts = [];
               	// 권한 목록 삭제..
               	posts.push({url:App.baseurl+"/delete",data:{qid:"permissiondelete", pid:save.id}});
				
				$('.rpermission input[name=permission]').each(function(i,e) { 
                   	posts.push({url:App.baseurl+"/insert",data:{qid:"permissionadd", pid:save.id, utype:$(this).val().indexOf('grp_')>=0?'group':'user', rwtype:'R', uid:$(this).val()}});
				}); 
				$('.wpermission input[name=permission]').each(function(i,e) { 
                   	posts.push({url:App.baseurl+"/insert",data:{qid:"permissionadd", pid:save.id, utype:$(this).val().indexOf('grp_')>=0?'group':'user', rwtype:'W', uid:$(this).val()}});
				}); 
               	
               	// 다중 post...
               	multi_post(posts);
				
				$('#dashname').text(save.name);
				$('#save-modal').modal('hide');
				App.msg_alert('대시보드', '저장되었습니다.', function() {});
			}
			else App.msg_alert('저장오류', '저장에 오류가 발생했습니다.');
			
		});
		
	});
	
	capture('#page-content', function(imgurl) {
		$('[name=preview]').attr('src', imgurl);
	});
	
	$('#save-modal').modal({backdrop:'static'});
	
});

var loaddashs = [];

function updatedashdata(name, data)
{
	$('#dashname').text(name);
	
	var lst = data; //JSON.parse(data);
	for(var i=0; i<lst.length; i++)
	{
		var item = lst[i];
		
		if(item.type=="line") addchart(item.facilityid, item.ids, item.range, item.ftime, item.ttime, item.timer_interval, item.id, item.left, item.top, item.width, item.height);
		else if (item.type=="pie") addpie(item.facilityid, item.ids, item.range, item.ftime, item.ttime, item.timer_interval, item.id, item.left, item.top, item.width, item.height);
		else if (item.type=="text") addstatictext(item.text, item.id, item.fontattr, item.left, item.top, item.width, item.height);
		else if (item.type=="sensortext") addtext(item.facilityid, item.ids, item.range, item.ftime, item.ttime, item.timer_interval, item.id, item.text, item.fontattr, item.left, item.top, item.width, item.height);
		else if (item.type=="img") addimg(item.text, item.id, item.left, item.top, item.width, item.height);
		else if (item.type=="background") {
			$("#charts").css("background-image", item.data).css("background-repeat","no-repeat");
        	$('#btnAddBack').text("배경지우기");
		}
	}
}

function loaddash(i) {
	var info = loaddashs[i];

	clearAllChart();
	
	$('#save-modal [name=name]').val(info.name);
	$('#save-modal [name=id]').val(info.id);

	$('.rpermission').empty();
	$('.wpermission').empty();
	
	if(info.rwtype=="W" || info.author==App.loginid) // 작성자또는 쓰기권한자..
	{
		$('.W').show();
	}
	else
		$('.W').hide();
	
	if(info.permissions === undefined) info.permissions = "";
	var infos = info.permissions.split(",");
	for(var i=0; i<infos.length; i++)
	{
		if(infos[i]=="") continue;
		var perm = infos[i].split('|');
		
		if(perm[3]=="W") $('.wpermission').append('<div>&nbsp;<button name=pbtndel type="button">삭제</button>&nbsp;<input type=hidden name=permission value="'+perm[0]+'">'+perm[1]+"("+perm[2]+')<br></div>');
		else if(perm[3]=="R") $('.rpermission').append('<div>&nbsp;<button name=pbtndel type="button">삭제</button>&nbsp;<input type=hidden name=permission value="'+perm[0]+'">'+perm[1]+"("+perm[2]+')<br></div>');
	}
	
	$('#open-modal').modal('hide');
	
	$('#btnAddBack').text("배경이미지");
	$("#charts").css("background", "none");
	$("#charts").css("background-image","");
	
	updatedashdata(info.name, JSON.parse(info.data));
}

function deldash(i) {
	var info = loaddashs[i];
	
	App.msg_confirm('대시보드', '['+info.name+'] 대시보드를 삭제 할까요?', function() {
		
		var cond = {qid:"dashboarddelete"};
		cond.id = info.id;
		$.post(App.baseurl+"/list",cond).done(function(res) {
			if(res.success)
			{
				$('#open-modal').modal('hide');
			}
		});
		
	});
}

function defdash(i) {
	var info = loaddashs[i];
	
	$('#open-modal').modal('hide');
	
	
	var obj = {name:info.name,data:info.data};

	var savestr = JSON.stringify(obj);
	
//	var v = {"name":"TS0005-온도대시보드","data":"[{"id":"pie1","sql":null,"facilityid":"TS0005","cols":null,"ids":"dev_1794450379","range":"300s","ftime":"","ttime":"","timer_interval":"5","type":"pie","cinfo":{"bigo":"온도1(PV)","unit":"℃","vname":"TEMPERATURE1(PV)","vtype":"정수","vrange":"0~2000","name":"온도1(PV)","id":"dev_1794450379","state":"ACTIVE","udate":"2021-05-09T15:00:00.000+0000","wdate":"2021-05-09T15:00:00.000+0000"},"idx":0,"data":null,"obj":null,"timer":15088},{"id":"pie2","sql":null,"facilityid":"TS0005","cols":null,"ids":"dev__99261750","range":"300s","ftime":"","ttime":"","timer_interval":"5","type":"pie","cinfo":{"bigo":"온도1(SV)","unit":"℃","vname":"TEMPERATURE1(SV)","vtype":"정수","vrange":"0~2000","name":"온도1(SV)","id":"dev__99261750","state":"ACTIVE","udate":"2021-05-09T15:00:00.000+0000","wdate":"2021-05-09T15:00:00.000+0000"},"idx":1,"data":null,"obj":null,"timer":15089},{"id":"pie3","sql":null,"facilityid":"TS0005","cols":null,"ids":"dev__862962453","range":"300s","ftime":"","ttime":"","timer_interval":"5","type":"pie","cinfo":{"bigo":"OVER TEMP","unit":"℃","vname":"OVER_TEMP","vtype":"정수","vrange":"0~2000","name":"OVER TEMP","id":"dev__862962453","state":"ACTIVE","udate":"2021-05-09T15:00:00.000+0000","wdate":"2021-05-09T15:00:00.000+0000"},"idx":2,"data":null,"obj":null,"timer":15090}]"};
	
	$.post(App.baseurl+"/update",{qid:"configput",key:App.loginid+"_defdashboard",value:savestr});	
}

$('#dashboardOpen').click(function() {
	
	var cond = {qid:"userdashboard",userid:App.loginid};
	cond.column = "name";
	cond.name =  '';
	$.post(App.baseurl+"/list",cond).done(function(res) {
		$('#dashboards').empty().append('<p><b>저장된 대시보드가 없습니다.</b></p>');
		if(res.success && res.list.length>0)
		{
			var html = "<table class='dashlist'><tr><th>이름</th><th>미리보기</th><th>작업</th></tr>";
			var lastid = "";
			for(var i=0; i<res.list.length; i++)
			{
				var item = res.list[i];
				if(lastid==item.id) continue;
				lastid = item.id;
				html += "<tr><td>"+item.name+"</td><td><img width=100% src='"+item.preview+"'></td><th><button class='btn btn-xs btn-default' onclick='loaddash("+i+");'>불러오기</button><br>";
				if((item.rwtype=="W" || item.author==App.loginid) && delbtnclass!="hide") html += "<button class='btn btn-xs btn-default' onclick='deldash("+i+");'>삭제</button><br>";
				html += "<button class='btn btn-xs btn-default' onclick='defdash("+i+");'>기본대시보드지정</button></th></tr>";
			}
			html += "</table>";
			loaddashs = res.list;
			
			$('#dashboards').html(html);
		}
	});
	
	$('#open-modal').modal({backdrop:'static'});
	
});
if(showtimeout === undefined)
{
	var showtimeout = null;
} else {
	if(showtimeout!=null) clearTimeout(showtimeout);
	showtimeout = null;
}

$('#page-content').off('mousemove').on('mousemove', function() {
	if($('.push_dash').length<=0) return;
	$('.push_dash').slideDown(500);
	
	if(showtimeout!=null) {
		clearTimeout(showtimeout);
		showtimeout = null;
	}
	showtimeout = setTimeout(function() {$('.push_dash').slideUp(500);}, 10000);
});

$('.push_dash').hide();

// 캠쳐...
function capture(selector,callback)
{
	html2canvas($(selector)[0]).then(function(canvas) {
		var imgurl = canvas.toDataURL("image/jpeg");
		if(callback!==undefined) callback(imgurl); 
	});
}

// W 권한 없을때...
var delbtnclass = "";
if(App.menus[App.curpage] !== undefined)
{
	if(App.menus[App.curpage].rwtype!="W") {
		$('#dashboardNew,#dashboardSave').hide();
		delbtnclass = 'hide';
	}
}

function clonelayout()
{
	var objs = [];
	for(var i=0; i<App.chartobjs.length; i++)
	{
		var chartobj = App.chartobjs[i];
		if(chartobj.fontattr===undefined) chartobj.fontattr="";
		
		if(chartobj.type=="text" || chartobj.type=="img"/* || chartobj.type=="sensortext"*/) objs.push({id:chartobj.id,text:chartobj.text,fontattr:chartobj.fontattr,type:chartobj.type,left:chartobj.left,top:chartobj.top,width:chartobj.width,height:chartobj.height});
		else objs.push({id:chartobj.id,text:chartobj.text,fontattr:chartobj.fontattr,facilityid:chartobj.facilityid,ids:chartobj.ids,range:chartobj.range,ftime:chartobj.ftime,ttime:chartobj.ttime,timer_interval:chartobj.timer_interval,type:chartobj.type,cinfo:chartobj.cinfo,idx:chartobj.idx,left:chartobj.left,top:chartobj.top,width:chartobj.width,height:chartobj.height});
		
		/*
		objs[i].sql = null;
		objs[i].cols = null;
		objs[i].obj = null;
		objs[i].data = null;
		*/
	}

	return objs;
}

var layoutmode = false;

$('#btnlayout').off('click').on('click',function() {
	
	if(layoutmode)
	{
		updatepos();
		var name = $('#dashname').text();
		var id = $('#save-modal [name=id]').val();
		// data 복사...
		var objs = clonelayout();
		
		clearAllChart();

		$('#save-modal [name=name]').val(name);
		$('#save-modal [name=id]').val(id);
		
		// 다시그리기...
		updatedashdata(name, objs);
		
		layoutmode = false;
	}
	else {
		$('.chart').draggable({grid:[20,20]}).resizable({grid:20}); //.resize(resizeevt);
		layoutmode = true;	
		updatepos();
		$('#btnlayout').html('<i class="fa fa-pencil-square-o"></i> 레이아웃고정');
	}
});


$(document).off('resize','div.text,div.sensortext').on('resize','div.text,div.sensortext',function() {
//	updatepos();

	if($(this).hasClass('text') || $(this).hasClass('sensortext') )
	{
//		$(this).css("font-size", $(this).height()-5);
		$(this).css("line-height", $(this).height()+"px");
	}
});

function updatepos()
{
//	console.log('updatepos');
	for(var i=0; i<App.chartobjs.length; i++)
	{
		var chartobj = App.chartobjs[i];
		
		var obj = null;
		if(chartobj.type=="line"||chartobj.type=="pie") obj = $('#'+chartobj.id).parent();
		else obj = $('#'+chartobj.id);
		
		chartobj.left = obj.position().left;
		chartobj.top = obj.position().top;
		chartobj.width = obj.width();
		chartobj.height = obj.height();
	}
}

$('#btnAddtext').off('click').on('click', function() {
	addstatictext("Text");
});

//단순 text 추가 id 가 있으면 load
function addstatictext(text, id, fontattr, left, top, width, height)
{
	var chartobj = makechartobj(id);
	var style = "display:inline-block;width:400px;height:40px;line-height:40px;";
	var fontsize = "35";
	if(left!==undefined) {
		style = "position:absolute; display:inline-block; left:"+left+"px;top:"+top+"px;width:"+width+"px;height:"+height+"px;line-height:"+height+"px;";
		fontsize = height - 5;
	}
		
	$("#charts").append("<div id='"+chartobj.id+"' class='chart text' style='"+style+";font-size:"+fontsize+"px'>"+text+"</div>");
	
	if(fontattr!=undefined)
	{
		var obj = $('#'+chartobj.id);
		var attrs = fontattr.split("|"); 
		
		obj.css('font-size',attrs[0]+"px");
		obj.css('font-family',attrs[1]);
		obj.css('font-weight',attrs[2]);
		obj.css('color',attrs[3]);
		obj.css('background-color',attrs[4]);
	}
	
	chartobj.type = "text";
	chartobj.text = text;
    chartobj.left = left;
    chartobj.top = top;
    chartobj.width = width;
    chartobj.height = height;
    chartobj.fontattr = fontattr;
	
	App.chartobjs.push(chartobj);
}

//sessor text 추가 id 가 있으면 load
function addtext(facilityid, sensorids, range, ftime, ttime, timer, id, text, fontattr, left, top, width, height)
{
 	var sids = sensorids.split(",");
	var infos = sensor_infos(sensorids);
	
	console.log('infos',infos);
 	
 	for(var ci=0; ci<sids.length; ci++)
 	{
 		var chartobj = makechartobj(id); //{};
		
		var cols = sensor_cols(sids[ci]);
		var sql = "select "+cols+ " from "+facilityid+" "; 
		if(range=="") {
			sql += "where time >='"+ftime+"' and time <='"+ttime+"'";
		}
		else
			sql += "where time >=now()-"+range;
		sql += " order by time desc limit 1";
		
		chartobj.sql = sql;
		
	    chartobj.facilityid = facilityid;
	    chartobj.cols = cols;
	    chartobj.ids = sids[ci];
	    chartobj.range = range;
	    chartobj.ftime = ftime;
	    chartobj.ttime = ttime;
	    chartobj.timer_interval = timer;
	    chartobj.type = "sensortext";
	    chartobj.cinfo = infos[ci];
	    chartobj.idx = ci;
	    chartobj.text = text;
	    chartobj.left = left;
	    chartobj.top = top;
	    chartobj.width = width;
	    chartobj.height = height;
	    chartobj.fontattr = fontattr;
	    
	    
	    if(text===undefined)
	    	chartobj.text = chartobj.cinfo.name+":{}";
	    else
	    	chartobj.text = text;
		
		query("facility", chartobj.sql, function(issuccess, result, cobj) {
			if(issuccess)
			{
				var xvals = [];
				var yvals = [];
				var ylabel = [];

				// columns info
				for(var i=0;i<result.results[0].series[0].columns.length; i++)
				{
					var item = result.results[0].series[0].columns[i];
					if(i>0) ylabel.push(item);
				}
				
//				console.log("labels", ylabel);
				// values
				for(var i in result.results[0].series[0].values)
				{
					var items = result.results[0].series[0].values[i];
					var t = (new Date(items[0])).format("HH:mm:ss");
					xvals.push(t);
					
					for(var c=1; c<items.length;c++) {
						if(i==0) 
							yvals.push([ items[c] ]);
						else
							yvals[c-1].push(items[c]);
					}
				}
				
				cobj.data = yvals[0]; //{vals:[xvals,yvals],labels:["시간",ylabel]};
				
				var style = "display:inline-block; width:400px;height:40px;line-height:40px;";
				var fontsize = "35";
				if(left!==undefined) {
					style = "position:absolute; display:inline-block; left:"+left+"px;top:"+top+"px;width:"+width+"px;height:"+height+"px;line-height:"+height+"px;";
					fontsize = height-5;
				}
				
				var text = cobj.text;
				text = text.split("{}").join(cobj.data);
				$("#charts").append("<div class='chart sensortext' data-text='"+ cobj.text+"' id="+cobj.id+" style='font-size:"+fontsize+"px;"+style+"'>"+text+"</div>");
				
				if(fontattr!=undefined)
				{
					var obj = $('#'+cobj.id);
					var attrs = fontattr.split("|"); 
					
					obj.css('font-size',attrs[0]+"px");
					obj.css('font-family',attrs[1]);
					obj.css('font-weight',attrs[2]);
					obj.css('color',attrs[3]);
					obj.css('background-color',attrs[4]);
				}
				
				cobj.timer = null; //setTimeout();
				if(cobj.timer_interval!="") cobj.timer = setTimeout(refreshtext, 1000*cobj.timer_interval, cobj);
				
				App.chartobjs.push(cobj);
			}
			else
			{
				console.log('query error...['+chartobj.sql+']');
			}
		},chartobj);
 	}
}

function refreshtext(chartobj)
{
//	console.log('refreshtext_'+chartobj.id+(new Date()).format('yyyy-MM-dd HH:mm:ss'));
	if($('#'+chartobj.id).length<=0) {
		return;
	}
	
	query("facility", chartobj.sql, function(issuccess, result, param) {
		if(issuccess)
		{
			var xvals = [];
			var yvals = [];
			var ylabel = [];

			// columns info
			for(var i=0;i<result.results[0].series[0].columns.length; i++)
			{
				var item = result.results[0].series[0].columns[i];
				if(i>0) ylabel.push(item);
			}
			
//			console.log("labels", ylabel);
			// values
			for(var i in result.results[0].series[0].values)
			{
				var items = result.results[0].series[0].values[i];
				var t = (new Date(items[0])).format("HH:mm:ss");
				xvals.push(t);
				
				for(var c=1; c<items.length;c++) {
					if(i==0) 
						yvals.push([ items[c] ]);
					else
						yvals[c-1].push(items[c]);
				}
			}
			chartobj.data = yvals[0]; //{vals:[xvals,yvals],labels:["시간",ylabel]};

			var text = chartobj.text;
			text = text.split("{}").join(chartobj.data);
			/*
			var mode = $('#btnlayout').text().trim();
			console.log('refresh text...'+mode);
			
			if(mode.indexOf("고정")>0)
			{
				console.log('resize...');
				$('#'+chartobj.id).text(text);
				$('#'+chartobj.id).resizable({grid:20});
			}
			else 
			*/
			if($('#btnlayout').text().trim()=="레이아웃편집") $('#'+chartobj.id).text(text);
		}
		else
		{
			console.log('query error...['+chartobj.sql+']', chartobj);
		}
		
		if(chartobj.timer!=null) {
			clearTimeout(chartobj.timer);
			chartobj.timer = null;
		}
		if(chartobj.timer_interval!="") chartobj.timer = setTimeout(refreshtext, 1000*chartobj.timer_interval, chartobj);
	});
}

$('#btnAddBack').click(function() {

	if($('#btnAddBack').text().indexOf("배경지우기")>=0)
	{
    	$("#charts").css("background", "none");
    	$("#charts").css("background-image","");
    	$('#btnAddBack').text("배경이미지");
		return;		
	}
	
	$('#file').unbind('change').change(function() {

		if($('#file').get(0).files.length<=0) return;
		input_file = $('#file').get(0).files[0];
		var file = input_file;
		var fileName = file.name;
		
		var reader = new FileReader();
        reader.onload = function(e){
        	
//        	var html = '<img style="position:absolute; left:0;top:0;" src='+e.target.result+' />';
//        	$("#charts img:first").remove();
//        	$("#charts").append(html);
        	$("#charts").css("background-image", "url("+e.target.result+")").css("background-repeat","no-repeat");
        	$('#btnAddBack').text("배경지우기");
//			addimg(e.target.result);
			$('#file').val('');
        };
        reader.readAsDataURL(file);
		
	});
	
	$('#file').click();
	
});

// img 추가 id 가 있으면 load
function addimg(img, id, left, top, width, height)
{
	var chartobj = makechartobj(id);
	var style = "left:0px;top:0px;";
	if(left!==undefined) {
		style = "position:absolute; display:inline-block; left:"+left+"px;top:"+top+"px;width:"+width+"px;height:"+height+"px;";
	}
		
	$("#charts").append("<img id='"+chartobj.id+"' class='chart img' style='"+style+"' src='"+img+"'/>");

	chartobj.type = "img";
	chartobj.text = img;
	App.chartobjs.push(chartobj);
}


function findchartobj(id)
{
	if(App.chartobjs===undefined) return null;
	
	for(var i = 0; i<App.chartobjs.length; i++)
	{
		if(App.chartobjs[i].id==id) {
			return App.chartobjs[i];
		}
	}
	return null;	
}

$(document).off('dblclick', 'div.text,div.sensortext').on('dblclick', 'div.text,div.sensortext', function() {
	var id = $(this).attr("id");
	var fobj = findchartobj(id);
	if(fobj==null) return;
	
	if($(this).hasClass('text'))
	{
		var newtxt = prompt('변경할문자열?',$(this).text());
		if(newtxt!=null)
		{
			$(this).text(newtxt);
			fobj.text = newtxt;
		}
	}
	else
	{
		var val = $(this).text();
		var fmt = $(this).data("text");
		fmt = fmt.split("{}").join("");
		
		val = val.split(fmt).join("");
		
		var newtxt = prompt('변경할문자열({} 에는 센서값이 치환됩니다.)?',$(this).data("text"));
		
		if(newtxt!=null)
		{
			$(this).data("text", newtxt);
			fobj.text = newtxt;
		
			val = newtxt.split("{}").join(val);
			$(this).text(val);
		}
	}
	
});

var h = $('body')[0].scrollHeight-$('header').height()-$('footer').height()-130;
$('#charts').css('height',h);

</script>
<!-- 스크립트 영역 -->